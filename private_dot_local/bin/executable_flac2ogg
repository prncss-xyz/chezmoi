#!/bin/bash

# ==============================================================================
# FLAC to Ogg Vorbis Converter Script
#
# This script scans a source directory for FLAC files and converts them to
# Ogg Vorbis files in a specified target directory, preserving the original
# subdirectory structure.
#
# Prerequisites: 'ffmpeg' utility must be installed and compiled with libvorbis support.
# ==============================================================================

# Check for required utility: ffmpeg
if ! command -v ffmpeg &> /dev/null
then
    echo "Error: Required utility 'ffmpeg' not found." >&2
    echo "Please ensure it is installed (e.g., using 'sudo apt install ffmpeg')." >&2
    exit 1
fi

# --- Usage Function ---
usage() {
    echo "Usage: $0 <source_directory> <target_directory>"
    echo ""
    echo "  <source_directory>: The folder containing the FLAC files (e.g., ./Music/FLAC)."
    echo "  <target_directory>: The folder where the OGG files will be saved (e.g., ./Music/OGG)."
    echo ""
    echo "Example: $0 ./MyFLACs ./MyOGGs"
    exit 1
}

# Check for correct number of arguments
if [ "$#" -ne 2 ]; then
    usage
fi

SOURCE_DIR=$(realpath "$1")
TARGET_DIR=$(realpath "$2")

# Check if source directory exists
if [ ! -d "$SOURCE_DIR" ]; then
    echo "Error: Source directory '$SOURCE_DIR' does not exist." >&2
    exit 1
fi

# Create target directory if it doesn't exist
if [ ! -d "$TARGET_DIR" ]; then
    echo "Target directory '$TARGET_DIR' does not exist. Creating it now..."
    mkdir -p "$TARGET_DIR" || { echo "Error: Failed to create target directory '$TARGET_DIR'." >&2; exit 1; }
fi

echo "--- Starting FLAC to Ogg Conversion using FFmpeg ---"
echo "Source: $SOURCE_DIR"
echo "Target: $TARGET_DIR"
echo "Quality setting: -q:a 5 (VBR)"
echo "----------------------------------------------------"

# Use find to locate all .flac files and loop through them
# -print0 and read -d $'\0' handle filenames with spaces or special characters correctly
find "$SOURCE_DIR" -type f -name "*.flac" -print0 | while IFS= read -r -d $'\0' FLAC_FILE; do

    # 1. Determine the relative path of the file
    # This removes the source directory path from the start of the full file path
    RELATIVE_PATH="${FLAC_FILE#$SOURCE_DIR/}"

    # 2. Construct the full path for the target OGG file
    # This replaces the .flac extension with .ogg
    OGG_FILE="$TARGET_DIR/${RELATIVE_PATH%.flac}.ogg"

    # 3. Get the directory of the target OGG file
    TARGET_SUBDIR=$(dirname "$OGG_FILE")

    # 4. Create the corresponding subdirectory in the target location
    if [ ! -d "$TARGET_SUBDIR" ]; then
        mkdir -p "$TARGET_SUBDIR"
        echo "Created directory: $TARGET_SUBDIR"
    fi

    # 5. Perform the conversion
    echo "Converting: $(basename "$FLAC_FILE") -> $(basename "$OGG_FILE")"

    # Use ffmpeg:
    # -i "$FLAC_FILE": Input file
    # -c:a libvorbis: Audio codec (Ogg Vorbis)
    # -q:a 5: Quality level (VBR, 0-10, 5 is a good balance)
    # -y: Overwrite output file without asking
    ffmpeg -i "$FLAC_FILE" -c:a libvorbis -q:a 5 "$OGG_FILE" -y >/dev/null 2>&1

    if [ $? -eq 0 ]; then
        echo "  [SUCCESS]"
    else
        echo "  [FAILURE] Could not convert '$FLAC_FILE'. Check if FFmpeg has libvorbis support." >&2
    fi

done

echo "---------------------------------------"
echo "Conversion process completed."
echo "Total Ogg files should be in: $TARGET_DIR"
echo "---------------------------------------"

exit 0
